#Using gRAICAR: a tutorial
--
Zhi Yang Ph.D. 

Institute of Psychology, Chinese Academy of Sciences

Last revision: Feb 14, 2015, Version 1.1


## Note
**The quality of the spatial normalization is critical for gRAICAR analysis. Please check the quality before gRAICAR analysis.**

For a description of gRAICAR algorithm, see here.


## Installation
### With MATLAB
If you have a working MATLAB, simply add the full path of the gRAICAR package to MATLAB path. An example:

```matlab
addpath(genpath('full_path_to_gRAICAR'));
```

### Without MATLAB
We provide complied packages for users without MATLAB. Please first install the MATLAB Compiler Runtime ([download](http://www.mathworks.com/products/compiler/mcr/index.html?refresh=true&s_tid=gn_loc_drop) for free). Then run gRAICAR by executing the corresponding package for your operating system (win64, macos64, linux64).


## Setting up an analysis
### The GUI
Start gRAICAR GUI mode by typing the following in MATLAB command window:

```matlab
gRAICAR_GUI
```
This command brings up a GUI like the following:

![Initial gRAICAR GUI](gRAICAR_GUI_init_1.1.png)


The red texts in the six text boxes indicate the meaning of the six mandatory arguments (see below for details).

Except the '_Task Name_' argument, the other mandatory arguments can be input using either the text boxes (the red texts will be automatically removed when user starts typing) or the file selection buttons.

The settings can be saved into a '.mat' file using the '_Save Settings_' button. The '.mat' file can be loaded in using the '_Load Settings_' button. 

When the '_Run!_' button is pressed, the input arguments will be checked. If no error is found, gRAICAR computation will start. Otherwise, an error message like the follow will show up.

![gRAICAR GUI check argument error](gRAICAR_GUI_checkerr.png)


###Meaning of the parameters

_Work Dir:_ Full path of the working directory of the entire analysis.

_Output Dir:_ Full path of output directory of the analysis. All files generated by gRAICAR will be in this directory. See '_Demo_' directory for an example of the recommend directory structure.

_Subjs List:_ Full path of a subject list file, which contains the directory name for each subject. See '_Demo/0scripts/subjs.list_' for an example.

_Task Name:_ A name for the current analysis. gRAICAR will use this name as a prefix for all of its outputs.

_Mask File:_ Full path of a group-level mask (spatially normalized to standard space).

_Num. Cores:_ Number of CPU cores to use when parallel computing is possible. The default setting is the maximal available cores on the current computer.

_Save Movies of Component Maps:_ Checking this box will enable gRAICAR to write out movies of component maps across subjects, allowing users to inspect correspondence between component maps matched from different subjects. This operation will take some additional computation time and disk space.

_Generate Webpage Reports:_ Checking this box will enable gRAICAR to generate webpage reports of the gRAICAR results.

_Use RAICAR for ICA decomposition:_ If this box is NOT checked (default), gRAICAR will assume that ICA has been done on each individual, and the results are stored under the directories of individual subjects (see the _First ICA File_ text box). In contrast, if this box IS checked, the software will perform ICA on individual subjects using RAICAR. The _First ICA File_ text box will change to _First fMRI File_ that allows user to input the preprocessed fMRI dataset for the first subject. (see below for details)

_First ICA File:_ Full path of the spatially normalized ICA spatial map file (e.g., '_melodic\_IC\_mni152\_3mm.nii.gz_' from _MELODIC_) of the first subject. This text box is only available if the _Use RAICAR for ICA decomposition_ is NOT checked.

_First fMRI File:_ Full path of the preprocessed fMRI file of the first subject (e.g., '_rest\_filt\_mni152\_3mm.nii.gz_). The datasets should be normalized to standard space). This text box is only available if the _Use RAICAR for ICA decomposition_ IS checked.

###When running

When gRAICAR computation is running, a message (blue text) will show up below the _Run!_ button.

Depending on the computation stages, the message will be one of the following:

- Setting up gRAICAR analysis...
- Computing similarity matrix...
- Post processing...

If an error occurs in the computation, the message will change into red. The error message can be one of the following:

- Error in gRAICAR setup
- Error in distributed computing
- Error in post processing

These error messages are helpful for debugging.


## Run gRAICAR with RAICAR (automatically perform individual ICA)

When the '_Use RAICAR for ICA decomposition_' option IS checked, gRAICAR will first call RAICAR to perform ICA on the fMRI dataset for each subject. 

RAICAR repeatedly decompose fMRI dataset into spatially independent components using FastICA algorithm. The resultant components from different ICA instances (random initial conditions) are aligned and ranked according to their spatial similarity in different ICA instances. The spatial maps of corresponding components from different ICA instances are weighted averaged to yield the final component maps. 

### Perquisite
1. A group-level brain mask file (in _.nii_ or _.nii.gz_ format) that is normalized to a standard space.

2. Preprocessed fMRI dataset for each subject. The dataset should be spatially normalized to a standard space.

Here is a directory tree of the required files (also see the demo):

```bash
├── 0scripts
│   └── subjs.list
├── group
│   └── mask
│       └── grpmask.nii.gz
├── subj1
│   └── rest
│       └── rest_filt_mni152_3mm.nii
├── subj2
│   └── rest
│       └── rest_filt_mni152_3mm.nii
├── subj3
│   └── rest
│       └── rest_filt_mni152_3mm.nii
└── subj4
    └── rest
        └── rest_filt_mni152_3mm.nii
```

### ICA parameters in RAICAR

By default, the following ICA parameters are used. These parameters can be modified in '_gRAICAR_callRAICAR.m_'.

```matlab
subj.setup.ICAOption.approach = 'symm';
subj.setup.ICAOption.epsilon  = 0.0001;
subj.setup.ICAOption.maxNumIterations = 3000;
subj.setup.ICAOption.g        = 'tanh';
subj.setup.stabilization      = 'off' ;   % structure storing user-specified options 
					 % for ICA. for details see the FastICA help.
                                         % default:
                                         %     ICAOption.approach = 'symm'
                                         %     ICAOption.epsilon  = 0.0001
                                         %     ICAOption.maxNumIterations = 3000
                                         %     ICAOption.g        = 'tanh'
                                         %     ICAOption.stabilization   = 'off'
                                         % NOTE: once ICAOption is set to nonempty, all the
                                         % default values will be overwritten. This means,
                                         % even though you only need to modify one of the ICA 

subj.setup.webReport = 1;                % a flag indicating whether RAICAR will           
                                         % automatically generate a web-page report. set to 
                                         % 1 to generate. default = 1;
```

### RAICAR output

For each subject, RAICAR will make a directory called '_ICA/RAICAR/_' under the 'rest' directory. The file '_RAICAR\_ICA\_aveMap.nii.gz_' under the '_ICA/RAICAR/_' directory will be used in gRAICAR analysis.

RAICAR will also generate a webpage report to allow user to inspect the ICA results. See an example for one component below:


![RAICAR_webreport.png](RAICAR_webreport.png)




## Run gRAICAR without RAICAR (starts with existing ICA results)

When the '_Use RAICAR for ICA decomposition_' option is NOT checked, gRAICAR will assume that the ICA results for each subject have been put into the subject directory. It reads the ICA results file for gRAICAR analysis.

### Perquisite 

1. Independent Component Analysis has been performed on each individual. The ICA result file is in _.nii_, _.nii.gz_, or '_.mat_' format, and is put in each individual's own directory.

2. The component maps from the ICA are spatially normalized. 

3. A group-level brain mask file (in _.nii_ or _.nii.gz_ format) that is normalized to a standard space.

See [this page] (ICA_recommendation.md) for some recommendations for performing ICA, normalizing the ICA component maps, and generating group-level mask.

Here is a directory tree of the required files (also see the demo):

```bash
├── 0scripts
│   └── subjs.list
├── group
│   └── mask
│       └── grpmask.nii.gz
├── subj1
│   └── rest
│       └── ICA
│           └── melodic_autoDim
│               └── melodic_IC_mni152_3mm.nii
├── subj2
│   └── rest
│       └── ICA
│           └── melodic_autoDim
│               └── melodic_IC_mni152_3mm.nii
├── subj3
│   └── rest
│       └── ICA
│           └── melodic_autoDim
│               └── melodic_IC_mni152_3mm.nii
└── subj4
    └── rest
        └── ICA
            └── melodic_autoDim
                └── melodic_IC_mni152_3mm.nii
```


## Command line mode

gRAICAR can run in command line mode, which is suitable for running analysis on remote computation servers.

An example is provided in '_demo/0scripts/batch\_setup\_gRAICAR.m_':

```matlab
% template configuration for running gRAICAR using command line

% full path to working directory
settings.workdir    = '/Users/yangz/Documents/myCode/gRAICAR/demo';

% full path to output directory
settings.outdir     = '/Users/yangz/Documents/myCode/gRAICAR/demo/output';

% full path to subject list file
settings.subjlist   = '/Users/yangz/Documents/myCode/gRAICAR/demo/0scripts/subjs.list';

% full path to group mask
settings.maskpath   = '/Users/yangz/Documents/myCode/gRAICAR/demo/group/mask/grpmask.nii.gz';

% name of the analysis task
settings.taskname   = 'rest';

% number of cores for parallel computing
settings.ncores     = 4;

% whether to use RAICAR to perform ICA
settings.useRAICAR  = 0; % 1 == use RAICAR; 0 == use MELODIC

% full path to ICA result file of the first subject (generated by MELODIC)
% this is a mandatory argument if settings.useRAICAR = 1
settings.icapath    = '/Users/yangz/Documents/myCode/gRAICAR/demo/subj1/rest/ICA/melodic_autoDim/melodic_IC_mni152_3mm.nii.gz';

% full path to the preprocessed fMRI file
% this is a mandatory argument if settings.useRAICAR = 0
settings.fmripath   = '/Users/yangz/Documents/myCode/gRAICAR/demo/subj1/rest/rest_filt_mni152_3mm.nii.gz';

% switch to save a movie of component maps across subjects
settings.savemovie  = 1;

% switch to generated webpage reports
settings.webreport  = 1;

% display options for the webpage reports
settings.displayThreshold = 1.5000;
settings.compPerPage= 10;

%%%%%%%%%%% run gRAICAR %%%%%%%%%%%%%%
gRAICAR_run (settings);
```

Users can alter the path settings as needed and run this script in MATLAB.

## gRAICAR outputs
### Short version
The webpage report is a summary of gRAICAR results. Start viewing the reports by browsing the file '_00index1.html_' in the '_webreport_' directory (see _demo/output/webreport/00index1.html_).

**Overall statistics**

Here is an example of overall statistics on the webpage report:

![Overall Statistics](gRAICAR_report_overall.png)

These plots are displayed at the top of every page of the report to provide an overview of the inter-subject consistency of the aligned components. Users can locate component of interest based on these statistics.

The rank of mean inter-subject similarity ranks the aligned components according to the mean of inter-subject similarity (inter-subject consistency). A higher value indicates that the aligned component is consistently found in different subjects.

The ratio of significant subjects plot shows the fraction of subjects that significantly contributed to the given aligned component. The significance of a subject is defined by comparing the confidence of subject load to 0.05. A >0.05 confidence means a significant contribution from that subject (alternative test, see __Interpretation of the metrics__ for more information).

**Aligned components**

Here is one aligned component from the report:

![gRAICAR webpage report: an aligned component](gRAICAR_report_AC1.png)

If you click on the brain map, an unthresholded map will show up like this:

![gRAICAR webpage report: unthresholded map](gRAICAR_report_unthr.png)

### Interpretation of the metrics
**Component map**

The component maps shown in the report are thresholded by |Z|>1.5 by default, where the voxel-wise Z score here is the standardized score across the entire brain. Each component map is averaged from the ICA component maps of individual subjects (matched by gRAICAR). The weights in the averaging are different across subjects, which are centrality degree of the subjects.

The unthresholded maps are also included in the webpage reports, and can be viewed by clicking on the thresholded component maps.

**Inter-subject similarity matrix**

The inter-subject similarity matrix shows similarity across subjects. This matrix is different for different aligned components, reflecting inter-subject relationships reflected by the current brain network (current aligned component). Further analyses of this matrix may reveal information on homogeneous subgroups of individuals (for an example, see Yang Z et al., 2014 Sci Rep).


**Subject load**

The subject load index reflects centrality degree (in a weighted graph) of each subject. A higher subject load indicates a subject has a higher similarity to other subjects, and a lower subject load suggests that a subject is far from the others. Since the aligned component map is generated by weighted averaging individual component maps, subjects with higher subject load have stronger contribution to the component maps.

**Confidence of subject load**

The confidence of subject load represents the percentile of the subject load among a null distribution of maximal similarity obtained by random permutation. A higher confidence of subject load indicates a higher confidence that the subject is contributing to the current aligned component. If this index shows remarkable difference between subjects, it is suggested that there are potential subgroups.



### More details
The gRAICAR outputs are organized into the following directories/files under the specified output directory (see '_demo/output_' and [full directory tree of the demonstration](../demo/directoryTree.txt):

- _compMaps:_ a directory containing weighted averaged group-level component maps, e.g., _comp001.nii.gz_. If the '_Save Movies of Component Maps_' option is checked, the movies are also included in this directory, e.g., _movie\_comp001.nii.gz_. The movie files are 4-D datasets with the last dimension as subjects.
- _computeFile:_ a directory saving the partitions of the full similarity matrix between all ICA components from all subjects. These are intermediate results.
- _taskName\_aveMap.mat:_ a MATLAB data file saving the weighted averaged group-level component maps in matrix format. This file is useful for further analysis in MATLAB. The string '_taskName_' is the same as that specified before running gRAICAR.
- _taskName\_configFile.mat:_ a MATLAB data file saving the input arguments for gRAICAR.
- _taskName\_result.mat:_ a MATLAB data file containing all statistics from gRAICAR. The webpage report is generated based on these statistics.
- _taskName\_webreport:_ a directory containing the automatically generated webpage report. The index page is named as _00index1.html_.


